# Advanced usage

Authentication middleware might not fully support every use-case. To help you with more complex authentication flows, `next-firebase-auth-edge` provides a set of low-level building blocks:

## getFirebaseAuth

`getFirebaseAuth` function provides a number of server-side methods to handle more complex authentication flows.

It should be called with service account credentials as first parameter and Firebase API key as second parameter

```tsx
import { getFirebaseAuth } from "next-firebase-auth-edge";

const {
  getCustomIdAndRefreshTokens,
  verifyIdToken,
  createCustomToken,
  handleTokenRefresh,
  getUser,
  getUserByEmail,
  createUser,
  updateUser,
  deleteUser,
  verifyAndRefreshExpiredIdToken,
  setCustomUserClaims,
} = getFirebaseAuth(
  {
    projectId: 'your-firebase-project-id',
    clientEmail: 'firebase-adminsdk-nnw48@your-firebase-project-id.iam.gserviceaccount.com',
    privateKey: '-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n'
  },
  'YOUR FIREBASE API KEY',
);
```

### Methods

| Name                           | Type                                                                                               | Description                                                                                                                                                                                                                                   |
| ------------------------------ | -------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| getCustomIdAndRefreshTokens    | `(idToken: string, firebaseApiKey: string, appCheckToken?: string) => Promise<IdAndRefreshTokens>` | Generates a new set of id and refresh tokens for user identified by provided `idToken`. Accepts optional `appCheckToken` as a third argument. You should pass it if your app supports [App Check](https://firebase.google.com/docs/app-check) |
| verifyIdToken                  | `(idToken: string, checkRevoked?: boolean) => Promise<DecodedIdToken>`                             | Verifies provided `idToken`. Throws `AuthError`. See [source code](https://github.com/awinogrodzki/next-firebase-auth-edge/blob/main/src/auth/error.ts) for possible error types.                                                             |
| createCustomToken              | `(uid: string, developerClaims?: object) => Promise<string>`                                       | Creates a custom token for given firebase user. Optionally, it's possible to attach additional `developerClaims`                                                                                                                              |
| handleTokenRefresh             | `(refreshToken: string, firebaseApiKey: string) => Promise<VerifyTokenResult>`                                | Returns id `token` and `decodedToken` for given `refreshToken`                                                                                                                                                                                |
| getUser                        | `(uid: string) => Promise<UserRecord>`                                                             | Returns Firebase UserRecord by uid                                                                                                                                                                                                            |
| getUserByEmail                 | `(email: string) => Promise<UserRecord>`                                                           | Returns Firebase UserRecord by email                                                                                                                                                                                                          |
| createUser                     | `(request: CreateRequest) => Promise<UserRecord>`                                                  | Creates user and returns UserRecord. See official firebase [Create a user](https://firebase.google.com/docs/auth/admin/manage-users#create_a_user) docs for request examples                                                                  |
| updateUser                     | `(uid: string, request: UpdateRequest) => Promise<UserRecord>`                                     | Updates user by uid and returns UserRecord. See official firebase [Update a user](https://firebase.google.com/docs/auth/admin/manage-users#update_a_user) docs for request examples                                                           |
| deleteUser                     | `(uid: string) => Promise<void>`                                                                   | Deletes user                                                                                                                                                                                                                                  |
| setCustomUserClaims            | `(uid: string, customClaims: object ∣ null) => Promise<void>`                                      | Sets custom claims for given user. Overwrites existing values. Use `getUser` to fetch current claims                                                                                                                                          |
| verifyAndRefreshExpiredIdToken | `(token: string, refreshToken: string) => Promise<VerifyTokenResult ∣ null>`                                  | Verifies provided `idToken`. If token is expired, uses `refreshToken` to validate it. Returns `null` if token is not valid.     
